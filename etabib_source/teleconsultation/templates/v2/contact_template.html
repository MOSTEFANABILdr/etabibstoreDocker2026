{% extends "base.html" %}
{% load i18n static avatar_tags utils_tags crispy_forms_tags %}
{% block title %} {% trans title %} {% endblock %}
{% block style %}
<!-- SmartWizard CSS-->
<link href="https://cdn.jsdelivr.net/npm/smartwizard@6/dist/css/smart_wizard_all.min.css"
      rel="stylesheet" type="text/css" />
<!-- cropperjs -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.6/cropper.min.css">

{% endblock %}

{% block content %}
<div class="container">
    <div class="row justify-content-center align-items-center">
        <div class="col-lg-6 col-md-6 col-xs-12">
            <br/>
            <h5>{% trans "Rechercher les actes par patient" %}</h5>
            {% csrf_token %}
            {% crispy formpatient %}
            {{ formpatient.media }}
        </div>
        <div class="col-lg-2 col-md-2 col-xs-12 ">
            <h5>{% trans "Rafraîchir" %}</h5>
            <a onclick="allPatient()" class="btn btn-etabib"
               data-fm-head="{% trans 'Créer une demande' %}">
                <i class="fas fa-redo"></i>
            </a>
        </div>
        <div class="col-lg-4 col-md-4 col-xs-12 ">
            <h5>{% trans "Nouveau Compte" %}</h5>
            <button data-toggle="modal" data-target="#modal-patient" class="btn btn-etabib" onclick="loadForm()">
                <i class="fa fa-user-plus" aria-hidden="true"></i>
                {% trans 'Créer un Compte Patient' %}
            </button>
        </div>
    </div>

    <h1 class="page-header">
        <i class="fas fa-calendar"></i>
        {% trans 'Liste des patients' %}
    </h1>
    <div class="row">
        {% include 'partial/messages-alerts.html' %}
    </div>
    <div id="patient_container" class="endless_page_template row">
        {% include page_template %}
    </div>
</div>
<div class="modal fade" id="modal-patient" role="dialog" tabindex="-1" aria-hidden="true" onsubmit="">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
        </div>
    </div>
</div>
<!-- datepicker ============================================ -->
<script type="text/javascript"
        src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.9.0/moment-with-locales.min.js"></script>
<script type="text/javascript"
        src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datetimepicker/4.17.47/js/bootstrap-datetimepicker.min.js"></script>
{% endblock %}

{% block js %}
<!-- SmartWizard JS-->
<script src='https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.6/cropper.min.js'></script>
<script src="https://unpkg.com/smartwizard@6/dist/js/jquery.smartWizard.min.js" type="text/javascript"></script>
<!-- Image Cropper -->
<script src="{% static 'js/cropper/jquery-cropper.min.js' %}"></script>

<script src='{% static "el-pagination/js/el-pagination.js" %}'></script>

<script>

    function allPatient() {
       $(id_patient).empty().trigger('change')
        $('#patient_container').html("");
        //showing spinner
        $("#patient_container").html("<div id='page-loader' class='fade show d-none'><span class='spinner'></span></div>")
        //loading list
        $('#patient_container').load('{% url 'doctor-contact' %}', {'csrfmiddlewaretoken': '{{csrf_token}}'},function() {});
    }

    function post_idcards(blob1, blob2){
        // Pass the image file name as the third parameter if necessary.
        const formData = new FormData();
        formData.append('croppedImage', blob1, 'tmp-cropped-image.jpg');
        formData.append('croppedImage1', blob2, 'tmp-cropped-image1.jpg');
        formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');

        $.ajax('{% url 'post-card-id' %}', {
            xhr: function() {
                var xhr = new window.XMLHttpRequest();
                xhr.upload.addEventListener("progress", function(evt) {
                  if (evt.lengthComputable) {
                    var percentComplete = evt.loaded / evt.total;
                    percentComplete = parseInt(percentComplete * 100);
                    $('.progress-bar').css('width', percentComplete + '%');
                    $('.progress-bar').text(percentComplete + '%');
                    if (percentComplete === 100) {
                        $('#step-upload legend').text("{% trans 'جار استخراج المعلومات من البطاقة' %}");
                        $('#upload_progress').css("display", "none");
                        $('#smartwizard').smartWizard("loader", "show");
                    }
                  }
                }, false);
                return xhr;
              },
            method: 'POST',
            data: formData,
            processData: false,
            contentType: false,
            success(result) {
                $("#modal-patient .modal-content").html(result.html_form);
            },
            error() {
                $('#smartwizard').smartWizard("loader", "hide");
                $('#smartwizard').smartWizard("prev");
                $('#smartwizard').smartWizard("prev");
                alert('Veuillez Reessayer');

            },
        });
    }

    function setup_smartwizard(){
        // Init SmartWizard
        $('#smartwizard').smartWizard({
            autoAdjustHeight: false,
            lang: { // Language variables for button
              next: "{% trans 'الخطوة التالية >> ' %}",
              previous: "{% trans ' << الرجوع إلى الخلف' %}"
            },
           keyboard: {
              keyNavigation: false,
              keyLeft: [],
              keyRight: []
          },
        });
        var cropper = cropper1 = {};
        var blob1 = blob2 = {};
        var formDataPatient = new FormData();
        $("#smartwizard").on("leaveStep", function(e, anchorObject, currentStepIndex, nextStepIndex, stepDirection) {
            if (nextStepIndex == 1 && currentStepIndex ==0 ){//forward
                var $image = $('#image-crop');
                $image.cropper({
                    viewMode: 0,
                    scalable: false,
                    zoomable: false,
                });
                cropper = $image.data('cropper');

            }else if (nextStepIndex == 2 && currentStepIndex == 1 ) {
                var $image1 = $('#image-crop1');
                $image1.cropper({
                    viewMode: 0,
                    scalable: false,
                    zoomable: false,
                });
                cropper1 = $image1.data('cropper');

            }else if (nextStepIndex == 3 && currentStepIndex == 2 ) {
                $('#smartwizard').smartWizard("setOptions", {
                    toolbar: { showNextButton: true },
                });
                // Upload cropped image to server if the browser supports `HTMLCanvasElement.toBlob`.
                // The default value for the second parameter of `toBlob` is 'image/png', change it if necessary.
                cropper.getCroppedCanvas().toBlob((blob) => {
                    blob1 = blob;
                    cropper1.getCroppedCanvas().toBlob((blob) => {
                        blob2 = blob;
                        post_idcards(blob1, blob2);
                    });
                });
            } else {
                $("#modal-ok").addClass("disabled");
            }
        });

        // Put the uploaded Image in a img to Process it with Cropper
        var $imageInput = $("[data-js-image-input]");
        var $imageContainer = $("[data-js-image-container]");
        var $resultContainer = $("[data-js-result-container]");
        $imageInput.change(function(event) {
            event.stopPropagation();
            event.preventDefault();
            var file = event.target.files[0];

            var fileReader = new FileReader();
            var css = "width: 80%; height: 80%; object-position: 0% 0%; object-fit: scale-down;"
            fileReader.onload = (function(theFile) {
                return function(event) {
                    $imageContainer.html(
                    '<img id="image-crop" class="image" src="' + event.target.result + '" style="' + css + '">'
                    );
                };
            })(file);
            fileReader.readAsDataURL(file);
        });

        var $imageInput1 = $("[data-js-image-input1]");
        var $imageContainer1 = $("[data-js-image-container1]");
        var $resultContainer1 = $("[data-js-result-container1]");

        $imageInput1.change(function(event) {
            event.stopPropagation();
            event.preventDefault();
            var file = event.target.files[0];

            var fileReader = new FileReader();
            var css = "width: 80%; height: 80%; object-position: 0% 0%; object-fit: scale-down;"
            fileReader.onload = (function(theFile) {
                return function(event) {
                    $imageContainer1.html(
                    '<img id="image-crop1" class="image" src="' + event.target.result + '" style="' + css + '">'
                    );
                };
            })(file);
            fileReader.readAsDataURL(file);
        });
    }
    // end setup_smartwizard

    function loadForm() {
        var btn = $(this);
        $.ajax({
            url: "{% url 'doctor-contact-create' %}",
            type: 'get',
            dataType: 'json',
            beforeSend: function () {
            $("#modal-patient .modal-content").html("");
        },
        success: function (data) {
            $("#modal-patient .modal-content").html(data.html_form);
        }
        });
    }

    function loadCarteIDForm() {
        $.ajax({
                url: "{% url 'post-card-id' %}",
                type: 'get',
                beforeSend: function () {
                $("#modal-patient .modal-content").html("");
            },
            success: function (data) {
                console.log(data);
                $("#modal-patient .modal-content").html(data.form_carte);
                setup_smartwizard();
            }
        });
    }

    function saveForm(e, form_js) {
        e.preventDefault();
        var form = $(form_js);
        $.ajax({
            url: form.attr("action"),
            data: form.serialize(),
            type: form.attr("method"),
            dataType: 'json',
            success: function (data) {
                if (data.form_is_valid) {
                    $("#modal-patient .modal-content").html("<div class='text-center'><i class='fa fa-spinner fa-spin fa-2x'></i></div>")
                    $("#modal-patient .modal-content").load('{% url 'contact-qrcode' pk=0 %}'.replace('0',data.patient_id),
                    {'csrfmiddlewaretoken': '{{csrf_token}}'},
                    function() {});
            }
            else {
              $("#modal-patient .modal-content").html(data.html_form);
            }
          }
        });
        return false;
    }

$(function() {
    document.querySelector('select[name="patient"]').onchange=function() {
        patient = $(this).val();
        $('#patient_container').html("");
        $("#patient_container").html("<div class='text-center'><i class='fa fa-spinner fa-spin fa-2x'></i></div>");
        $('#patient_container').load('{% url 'doctor-contact' %}', {
                'patient_id': patient,
		        'csrfmiddlewaretoken': '{{csrf_token}}'
		    },
            function() {
            }
        );
    };
});
$(function() {
    const WS_CMD_DMND_REQUEST = "TELECONSULTATION_DEMAND";
    const WS_CMD_DMND_ACCEPTED = "TELECONSULTATION_DEMAND_ACCEPTED";
    const WS_CMD_DMND_CANCELED = "TELECONSULTATION_DEMAND_CANCELED";
    const WS_CMD_DMND_REJECTED = "TELECONSULTATION_DEMAND_REJECTED";
    const WS_CMD_ONLINE_DOC_COUNT =  "TELECONSULTATION_GET_ONLINE_DOCTORS_COUNT";
    var progress_is_shown = false;
    var medecin_id;

    //Endlesss pagination
	$.endlessPaginate({
	});

    notifSocket.addEventListener("message", function(e) {
        var data = JSON.parse(e.data);
        var command = data['command'];
        switch (command) {
            case WS_CMD_ONLINE_DOC_COUNT:
                var count = data['count'];
                $("#count").html(count);
                break;
            case WS_CMD_DMND_REJECTED:
                var code = data['code'];
                var msg="";
                if (code=="BUSY") {
                    msg = '{% trans "Désolé, le médecin est actuellement occupé." %}';
                } else if (code == "OFFLINE") {
                    msg = '{% trans "Désolé, le médecin est actuellement hors ligne." %}';
                } else if (code == "NOT_ENOUGH_MONEY") {
                    window.location.href = "{% url 'epayment-recharge' %}?u={% user_id_hash user %}&r=NOT_ENOUGH_MONEY";
                    return;
                }
                else {
                    msg = '{% trans "Désolé, le service est actuellement indisponible. réessayez après 1 minute" %}';
                }
                Lobibox.alert('warning',
                    {
                        title: ".",
                        buttons: {
                            ok: {
                                closeOnClick: true,
                                'class': 'btn btn-etabib',
                                text: "<i class='fa fa-check fa-2x'></i>"
                            }
                        },
                        msg: msg
                    }
                );
                break;
        }
    });


    $(document).on('click', '.teleconsultation-call', function() {
        var bool = CheckBrowserCompatibility();
        if (!bool) return;

        //read data attribute from li element
        patient_id = $(this).data("patient-id");
        var patient_name = $(this).data("patient-name");

        //Checking if socket is opened
        if (notifSocket.readyState === WebSocket.OPEN) {

            //show confirmation notification
            var lobibox = Lobibox.confirm({
                title: "{% trans 'Confirmation' %}",
                iconClass: false,
                buttons: {
                    yes: {
                        closeOnClick: true,
                        'class': 'btn btn-etabib',
                        text: "<i class='fa fa-phone fa-2x'></i>"
                    },
                    no: {
                        closeOnClick: true,
                        'class': 'btn btn-etabib',
                        text: "<i class='fa fa-remove fa-2x'></i>"
                    },
                },
                closable: false,
                msg: "{% trans 'Voulez vous appeler' %} " + patient_name + "?",
                callback: function($this, type, ev) {
                    if (type === 'yes') {
                        //if yes: send through the Websocket the teleconsultation demand
                        var progress_notif = Lobibox.progress({
                            closeButton: false,
                            progressTpl: '<div class="progress lobibox-progress-outer" style="height:5px;">\n\
                            <div class="progress-bar progress-bar-warning progress-bar-striped lobibox-progress-element" data-role="progress-text" style="height:5px;" role="progressbar"></div>\n\
                            </div>',
                            title: "{% trans 'En attente de connexion de' %} " + patient_name,
                            progressCompleted: function(lbx) {
                                progress_is_shown = false;
                                //send request to cancel demand
                                notifSocket.send(JSON.stringify({
                                    'command': WS_CMD_DMND_CANCELED,
                                    'patient_id': patient_id
                                }));
                                //TODO: Message NO RESPONSE
                                lbx.hide();
                            },
                            onShow: function(lbx) {
                                progress_is_shown = true;
                                if (notifSocket.readyState === WebSocket.OPEN) {
                                    var inter;
                                    notifSocket.send(JSON.stringify({
                                        'command': WS_CMD_DMND_REQUEST,
                                        'patient_id': patient_id
                                    }));
                                    //add listener to check on message event
                                    notifSocket.addEventListener("message", function(e) {
                                        var data = JSON.parse(e.data);
                                        var command = data['command'];
                                        switch (command) {
                                            case WS_CMD_DMND_ACCEPTED:
                                            case WS_CMD_DMND_REJECTED:
                                                inter = clearInterval(inter);
                                                //hide progress
                                                lbx.destroy();
                                                progress_is_shown = false;
                                                break;
                                        }
                                    });
                                    var i = 0;
                                    var step = 10;
                                    inter = setInterval(function() {
                                        if (i > 100) {
                                            inter = clearInterval(inter);
                                        }
                                        i = i + 0.025;
                                        lbx.setProgress(i);
                                    }, step);
                                }
                            }
                        });
                    }
                }
            });
        }
        else {
            //socket is not opened notify the user
            //TODO:
        }
    });

    //detect browser close event
    $(window).on("beforeunload", function() {
        if (progress_is_shown == true) {
            //send request to cancel demand
            notifSocket.send(JSON.stringify({
                'command': WS_CMD_DMND_CANCELED,
                'patient_id': patient_id
            }));
            //close socket
            notifSocket.close();
        }
    });
});
</script>
{% endblock %}
