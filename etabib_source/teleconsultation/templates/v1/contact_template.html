{% extends "base.html" %}
{% load i18n %}
{% load static %}
{% load avatar_tags utils_tags %}
{% load crispy_forms_tags %}
{% load teleconsultation_tags %}
{% block title %} {% trans title %} {% endblock %}
{% block style %}
<!-- Google Fonts
                    ============================================ -->
<link
        href="https://fonts.googleapis.com/css?family=Roboto:100,300,400,700,900"
        rel="stylesheet">
<!-- Bootstrap CSS
                    ============================================ -->
<link rel="stylesheet" href='{% static "css/bootstrap.min.css" %}'>
<!-- Bootstrap CSS
                    ============================================ -->
<link rel="stylesheet" href='{% static "css/font-awesome.min.css" %}'>
<!-- owl.carousel CSS
                    ============================================ -->
<link rel="stylesheet" href='{% static "css/owl.carousel.css" %}'>
<link rel="stylesheet" href='{% static "css/owl.theme.css" %}'>
<link rel="stylesheet" href='{% static "css/owl.transitions.css" %}'>
<!-- animate CSS
                    ============================================ -->
<link rel="stylesheet" href='{% static "css/animate.css" %}'>
<!-- normalize CSS
                    ============================================ -->
<link rel="stylesheet" href='{% static "css/normalize.css" %}'>
<!-- meanmenu icon CSS
                    ============================================ -->
<link rel="stylesheet" href='{% static "css/meanmenu.min.css" %}'>
<!-- main CSS
                    ============================================ -->
<link rel="stylesheet" href='{% static "css/main.css" %}'>
<!-- educate icon CSS
                    ============================================ -->
<link rel="stylesheet" href='{% static "css/educate-custon-icon.css" %}'>
<!-- morrisjs CSS
                    ============================================ -->
<link rel="stylesheet" href='{% static "css/morrisjs/morris.css" %}'>
<!-- mCustomScrollbar CSS
                    ============================================ -->
<link rel="stylesheet"
      href='{% static "css/scrollbar/jquery.mCustomScrollbar.min.css" %}'>
<!-- metisMenu CSS
                    ============================================ -->
<link rel="stylesheet"
      href='{% static "css/metisMenu/metisMenu.min.css" %}'>
<link rel="stylesheet"
      href='{% static "css/metisMenu/metisMenu-vertical.css" %}'>
<!-- modernizr JS
                    ============================================ -->
<script src='{% static "js/vendor/modernizr-2.8.3.min.js" %}'></script>
<link rel="stylesheet" href="https://unpkg.com/placeholder-loading/dist/css/placeholder-loading.min.css">
<style>
.card-header .fa {
  transition: .3s transform ease-in-out;
}
.card-header .collapsed .fa {
  transform: rotate(90deg);
}


</style>
{% endblock %}
{%block content %}
<div class="apps-area">
    <div class="container-fluid">
        <div class="col-lg-12">
            {% include 'partial/messages-alerts.html' %}
        </div>
        <div class="product-payment-inner-st">
            <div class="card">
                <div class="card-header">
                    <h1>{% trans 'Liste des patients' %}</h1>
                    <a data-toggle="collapse" href="#collapse-example" aria-expanded="true"
                       aria-controls="collapse-example"
                       id="heading-example" class="d-block">
                        <i class="fa fa-chevron-down floatright"></i>
                    </a>
                </div>
                <div id="collapse-example" class="collapse in" aria-labelledby="heading-example">
                    <div class="card-body">
                        {% crispy form %}
                    </div>
                </div>
            </div>
        </div>
        <div class="endless_page_template">
            {% include page_template %}
        </div>
    </div>
</div>
<!--Used as a template -->
<div id="placeholder_div" class="col-lg-3 col-md-6 col-sm-6 col-xs-12 hide">
    <div class="ph-item">
        <div class="ph-col-12">
            <div class="ph-avatar"></div>
            <div class="ph-row">
                <div class="ph-col-6 big"></div>
                <div class="ph-col-4 empty big"></div>
                <div class="ph-col-2 big"></div>
                <div class="ph-col-4"></div>
                <div class="ph-col-8 empty"></div>
                <div class="ph-col-6"></div>
                <div class="ph-col-6 empty"></div>
                <div class="ph-col-12"></div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
{% block js %}
<!-- bootstrap JS
                    ============================================ -->
<script src='{% static "js/bootstrap.min.js" %}'></script>
<!-- wow JS
                    ============================================ -->
<script src='{% static "js/wow.min.js" %}'></script>
<!-- meanmenu JS
                    ============================================ -->
<script src='{% static "js/jquery.meanmenu.js" %}'></script>
<!-- owl.carousel JS
                    ============================================ -->
<script src='{% static "js/owl.carousel.min.js" %}'></script>
<!-- sticky JS
                    ============================================ -->
<script src='{% static "js/jquery.sticky.js" %}'></script>
<!-- scrollUp JS
                    ============================================ -->
<script src='{% static "js/jquery.scrollUp.min.js" %}'></script>
<!-- counterup JS
                    ============================================ -->
<script src='{% static "js/counterup/jquery.counterup.min.js" %}'></script>
<script src='{% static "js/counterup/waypoints.min.js" %}'></script>
<script src='{% static "js/counterup/counterup-active.js" %}'></script>
<!-- icheck JS
                    ============================================ -->
<script src='{% static "js/icheck/icheck.min.js" %}'></script>
<script src='{% static "js/icheck/icheck-active.js" %}'></script>
<!-- mCustomScrollbar JS
                    ============================================ -->
<script
        src='{% static "js/scrollbar/jquery.mCustomScrollbar.concat.min.js" %}'></script>
<script src='{% static "js/scrollbar/mCustomScrollbar-active.js" %}'></script>
<!-- metisMenu JS
                    ============================================ -->
<script src='{% static "js/metisMenu/metisMenu.min.js" %}'></script>
<script src='{% static "js/metisMenu/metisMenu-active.js" %}'></script>
<!-- plugins JS
                    ============================================ -->
<script src='{% static "js/plugins.js" %}'></script>
<!-- main JS
                    ============================================ -->
<script src='{% static "js/main.js" %}?4'></script>
<!-- endless pagination JS ============================================ -->
<script src='{% static "el-pagination/js/el-pagination.js" %}'></script>
<!-- tawk chat JS
                    ============================================ -->
{% include 'partial/tawk-script.html' %}
<script>
$(function() {
    const WS_CMD_DMND_REQUEST = "TELECONSULTATION_DEMAND";
    const WS_CMD_DMND_ACCEPTED = "TELECONSULTATION_DEMAND_ACCEPTED";
    const WS_CMD_DMND_CANCELED = "TELECONSULTATION_DEMAND_CANCELED";
    const WS_CMD_DMND_REJECTED = "TELECONSULTATION_DEMAND_REJECTED";
    const WS_CMD_ONLINE_DOC_COUNT =  "TELECONSULTATION_GET_ONLINE_DOCTORS_COUNT";
    var progress_is_shown = false;
    var medecin_id;

    //Endlesss pagination
	$.endlessPaginate({
	});

    notifSocket.addEventListener("message", function(e) {
        var data = JSON.parse(e.data);
        var command = data['command'];
        switch (command) {
            case WS_CMD_ONLINE_DOC_COUNT:
                var count = data['count'];
                $("#count").html(count);
                break;
            case WS_CMD_DMND_REJECTED:
                var code = data['code'];
                var msg="";
                if (code=="BUSY") {
                    msg = '{% trans "Désolé, le médecin est actuellement occupé." %}';
                } else if (code == "OFFLINE") {
                    msg = '{% trans "Désolé, le médecin est actuellement hors ligne." %}';
                } else if (code == "NOT_ENOUGH_MONEY") {
                    window.location.href = "{% url 'epayment-recharge' %}?u={% user_id_hash user %}&r=NOT_ENOUGH_MONEY";
                    return;
                }
                else {
                    msg = '{% trans "Désolé, le service est actuellement indisponible. réessayez après 1 minute" %}';
                }
                Lobibox.alert('warning',
                    {
                        title: ".",
                        buttons: {
                            ok: {
                                closeOnClick: true,
                                'class': 'btn btn-etabib',
                                text: "<i class='fa fa-check fa-2x'></i>"
                            }
                        },
                        msg: msg
                    }
                );
                break;
        }
    });


    $(document).on('click', '.teleconsultation-call', function() {
        var bool = CheckBrowserCompatibility();
        if (!bool) return;

        //read data attribute from li element
        patient_id = $(this).data("patient-id");
        var patient_name = $(this).data("patient-name");

        //Checking if socket is opened
        if (notifSocket.readyState === WebSocket.OPEN) {

            //show confirmation notification
            var lobibox = Lobibox.confirm({
                title: "{% trans 'Confirmation' %}",
                iconClass: false,
                buttons: {
                    yes: {
                        closeOnClick: true,
                        'class': 'btn btn-etabib',
                        text: "<i class='fa fa-phone fa-2x'></i>"
                    },
                    no: {
                        closeOnClick: true,
                        'class': 'btn btn-etabib',
                        text: "<i class='fa fa-remove fa-2x'></i>"
                    },
                },
                closable: false,
                msg: "{% trans 'Voulez vous appeler' %} " + patient_name + "?",
                callback: function($this, type, ev) {
                    if (type === 'yes') {
                        //if yes: send through the Websocket the teleconsultation demand
                        var progress_notif = Lobibox.progress({
                            closeButton: false,
                            progressTpl: '<div class="progress lobibox-progress-outer" style="height:5px;">\n\
                            <div class="progress-bar progress-bar-warning progress-bar-striped lobibox-progress-element" data-role="progress-text" style="height:5px;" role="progressbar"></div>\n\
                            </div>',
                            title: "{% trans 'En attente de connexion de' %} " + patient_name,
                            progressCompleted: function(lbx) {
                                progress_is_shown = false;
                                //send request to cancel demand
                                notifSocket.send(JSON.stringify({
                                    'command': WS_CMD_DMND_CANCELED,
                                    'patient_id': patient_id
                                }));
                                //TODO: Message NO RESPONSE
                                lbx.hide();
                            },
                            onShow: function(lbx) {
                                progress_is_shown = true;
                                if (notifSocket.readyState === WebSocket.OPEN) {
                                    var inter;
                                    notifSocket.send(JSON.stringify({
                                        'command': WS_CMD_DMND_REQUEST,
                                        'patient_id': patient_id
                                    }));
                                    //add listener to check on message event
                                    notifSocket.addEventListener("message", function(e) {
                                        var data = JSON.parse(e.data);
                                        var command = data['command'];
                                        switch (command) {
                                            case WS_CMD_DMND_ACCEPTED:
                                            case WS_CMD_DMND_REJECTED:
                                                inter = clearInterval(inter);
                                                //hide progress
                                                lbx.destroy();
                                                progress_is_shown = false;
                                                break;
                                        }
                                    });
                                    var i = 0;
                                    var step = 10;
                                    inter = setInterval(function() {
                                        if (i > 100) {
                                            inter = clearInterval(inter);
                                        }
                                        i = i + 0.025;
                                        lbx.setProgress(i);
                                    }, step);
                                }
                            }
                        });
                    }
                }
            });
        }
        else {
            //socket is not opened notify the user
            //TODO:
        }
    });

    //detect browser close event
    $(window).on("beforeunload", function() {
        if (progress_is_shown == true) {
            //send request to cancel demand
            notifSocket.send(JSON.stringify({
                'command': WS_CMD_DMND_CANCELED,
                'patient_id': patient_id
            }));
            //close socket
            notifSocket.close();
        }
    });
});

</script>
{% endblock %}
