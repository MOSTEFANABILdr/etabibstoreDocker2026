{% extends "base.html" %}
{% load i18n static teleconsultation_tags avatar_tags utils_tags crispy_forms_tags %}

{% block title %} {{contact.full_name}} {% endblock %}

{% block style %}
<!-- Uppy -->
<link href="https://releases.transloadit.com/uppy/v2.6.0/uppy.min.css" rel="stylesheet">
{% endblock %}
{% block content %}
{% if clinique %}
{% include 'partial/virtual_office_header.html' %}
{% endif %}
<div class="container mt-4">
    <div class="row">
        {% include 'partial/messages-alerts.html' with disable_slideup=True %}
    </div>
    <div class="row">
        <div class="col-lg-3 col-md-4 col-sm-12">
            <div class="card card-contact mb-2 border-0">
                {% if contact.medecin %}
                {% render_status contact.medecin.user as STATUS %}
                <div class="bubble {{STATUS}}"
                     title="{% ifequal STATUS 'online' %} {% trans 'En Ligne' %}
                    {% else %} {% trans 'hors ligne' %} {% endifequal %}">
                    <span class="bubble-outer-dot">
                        <span class="bubble-inner-dot"></span>
                    </span>
                </div>
                {% endif %}
                {% if contact.medecin %}
                {% avatar contact.medecin.user class="card-img-top rounded-circle mx-auto mt-2" %}
                {% else %}
                <img class="card-img-top rounded-circle mx-auto mt-2" src="{% static 'img/logo/logo_directory.png' %}">
                {% endif %}
                <div class="card-body text-center">
                    <div class="doctor-profile-telec">
                        <h5 title="{{contact.full_name|upper}}" class="card-title">
                            {{contact.full_name|upper}}
                        </h5>
                    </div>
                </div>
                <div class="card-footer text-center bg-white pl-0 pr-0">
                    {% if contact.medecin %}
                    {% if contact.medecin.is_online %}
                    <a data-medecin-id="{{contact.medecin.id}}"
                       title="{% trans 'Consultez Un Médecin par Appel Video' %}"
                       data-medecin-name="{{contact.medecin.full_name}}"
                       class="btn btn-etabib btn-lg btn-block demand-teleconsultation">
                        {% trans "إستشر عن بعد" %}
                        <img height="30px" class="pull-right" src="{% static 'v2/icons/rounded/9.svg' %}">
                    </a>
                    {% endif %}
                    {% has_rdv_with contact.medecin.user request.user as has_rdv %}
                    {% if not has_rdv.0 %}
                        <a title="{% trans 'حجز موعد' %}" href="#modal-rdv" data-toggle="modal"
                           class="btn btn-etabib btn-lg btn-block">
                            {% trans 'حجز موعد' %}
                            <img height="30px" class="pull-right" src="{% static 'v2/icons/rounded/7.svg' %}">
                        </a>
                    {% else %}
                        <a title="{% trans 'إلغاء الموعد' %}" data-medecin-id="{{contact.medecin.id}}"
                           data-has-rdv="{{has_rdv.0}}" data-demand-id="{{has_rdv.1}}" data-medecin-name="{{contact.medecin.full_name}}"
                           class="btn btn-etabib btn-lg btn-block demand-rdv">
                             {% trans 'إلغاء الموعد' %}
                            <img height="30px" class="pull-right" src="{% static 'v2/icons/rounded/7.svg' %}">
                        </a>
                    {% endif %}
                    {% is_from_care_team request.user.patient contact.medecin.user as IS_FROM_CARE_TEAM %}
                    {% if not IS_FROM_CARE_TEAM %}
                    <a data-medecin-id="{{contact.medecin.id}}"
                       title="{% trans 'AJOUTER À MON ÉQUIPE' %}"
                       data-medecin-name="{{contact.medecin.full_name}}"
                       class="btn btn-etabib btn-lg btn-block add-doc-team">
                        {% trans "أضف إلى فريق العناية" %}
                        <img height="30px" class="pull-right" src="{% static 'v2/icons/rounded/13.svg' %}">
                    </a>
                    {% endif %}
                    {% endif %}
                </div>
            </div>
        </div>
        <div class="col-lg-9 col-md-8 col-sm-12">
            <!-- begin panel -->
            <div class="panel panel-etabib" data-sortable="false">
                <div class="panel-heading">
                    <h4 class="panel-title">
                        {{contact.full_name|upper}} - {{contact.specialite|upper}}
                    </h4>
                </div>
                <div class="panel-body">
                    <!-- begin table -->
                    <div class="dl-horizontal pt-3 pb-3 pl-3 pr-3">
                        <h4>
                            <i class="fa fa-info-circle etabib-color"></i>
                            {% trans 'معلومات عن المهني' %}
                        </h4>
                        <dt class="field text-left">{% trans 'Nom & prénom' %}</dt>
                        <dd>
                            <label>
                                {{contact.full_name|default_if_none:""}}
                            </label>
                        </dd>
                        <dt class="field text-left">{% trans 'Sexe' %}</dt>
                        <dd>
                            <label>
                                {{contact.sexe|default_if_none:""}}
                            </label>
                        </dd>
                        <dt class="field text-left">{% trans 'Spécialité' %}</dt>
                        <dd>
                            <label>
                                {{contact.specialite|default_if_none:""}}
                            </label>
                        </dd>
                        <dt class="field text-left">{% trans 'Adresse' %}</dt>
                        <dd>
                            <label>
                                {{contact.full_address|default_if_none:""}}
                            </label>
                        </dd>
                        {% if contact.mobile_1 or contact.mobile_2 or contact.mobile or contact.fixe  %}
                        <dt class="field text-left">{% trans 'Téléphone' %}</dt>
                        <dd>
                            {% if contact.mobile_1 %}
                            <a class="text-decoration-none" href="tel:{{contact.mobile_1|default_if_none:''}}">
                                {{contact.mobile_1|default_if_none:""}}
                                <i class="fa fa-phone fa-2x text-dark"></i>
                            </a>
                            {% endif %}
                            {% if contact.mobile_2 %}
                            <a class="text-decoration-none" href="tel:{{contact.mobile_2|default_if_none:''}}">
                                {{contact.mobile_2|default_if_none:""}}
                                <i class="fa fa-phone fa-2x text-dark"></i>
                            </a>
                            {% endif %}
                            {% if contact.source == "16" and contact.mobile %}
                            <a class="text-decoration-none" href="tel:{{contact.mobile|default_if_none:''}}">
                                {{contact.mobile|default_if_none:""}}
                                <i class="fa fa-phone fa-2x text-dark"></i>
                            </a>
                            {% endif %}
                            {% if contact.fixe %}
                            <a class="text-decoration-none" href="tel:{{contact.fixe|default_if_none:''}}">
                                {{contact.fixe|default_if_none:""}}
                                <i class="fa fa-phone fa-2x text-dark"></i>
                            </a>
                            {% endif %}
                        </dd>
                        {% endif %}
                        {% if contact.fonction %}
                        <dt class="field text-left">{% trans 'Fonction' %}</dt>
                        <dd>
                            <label>
                                {{contact.fonction|default_if_none:""}}
                            </label>
                        </dd>
                        {% endif %}
                        {% if contact.organisme %}
                        <dt class="field text-left">{% trans 'Organisme' %}</dt>
                        <dd>
                            <label>
                                {{contact.organisme|default_if_none:""}}
                            </label>
                        </dd>
                        {% endif %}
                        {% if contact.experience %}
                        <dt class="field text-left">{% trans "Années d'expériences" %}</dt>
                        <dd>
                            <label>
                                {{contact.experience|default_if_none:""}}
                            </label>
                        </dd>
                        {% endif %}
                        {% if contact.pageweb %}
                        <dt class="field text-left">{% trans 'Page Web/Site Web' %}</dt>
                        <dd>
                            <a target="_blank" class="text-decoration-none"
                               href="{{contact.pageweb|default_if_none:''}}">
                                {{contact.pageweb|truncatechars:50}}
                            </a>
                        </dd>
                        </tr>
                        {% endif %}
                        {% if contact.facebook %}
                        <dt class="field text-left">{% trans 'Facebook' %}</dt>
                        <dd>
                            <a target="_blank" class="text-decoration-none"
                               href="{{contact.facebook|default_if_none:''}}">
                                {{contact.facebook|truncatechars:50}}
                            </a>
                        </dd>
                        {% endif %}
                        {% if contact.twitter %}
                        <dt class="field text-left">{% trans 'Twitter' %}</dt>
                        <dd>
                            <a target="_blank" class="text-decoration-none"
                               href="{{contact.twitter|default_if_none:''}}">
                                {{contact.twitter|truncatechars:50}}
                            </a>
                        </dd>
                        {% endif %}
                        {% if contact.linkedin %}
                        <dt class="field text-left">{% trans 'LinkedIn' %}</dt>
                        <dd>
                            <a target="_blank" class="text-decoration-none"
                               href="{{contact.linkedin|default_if_none:''}}">
                                {{contact.linkedin|truncatechars:50}}
                            </a>
                        </dd>
                        </tr>
                        {% endif %}
                        {% if contact.maps_url %}
                        <dt class="field text-left">{% trans 'Lien Maps' %}</dt>
                        <dd>
                            <a href="{{contact.maps_url}}">
                                {{contact.maps_url|truncatechars:50}}
                                <i class="fa fa-map-marker fa-2x text-dark"></i>
                            </a>
                        </dd>
                        {% endif %}
                    </div>
                    <div class="dl-horizontal pt-3 pb-3 pl-3 pr-3 mt-2">
                        <h4>
                            <i class="fa fa-info-circle etabib-color"></i>
                            {% trans 'الكفاءات والشهادات' %}
                        </h4>
                        <ul>
                            {% for qual in contact.qualifications.all %}
                            <li>
                                {{qual.libelle}}
                            </li>
                            {% endfor %}
                        </ul>
                    </div>
                    <div class="dl-horizontal pt-3 pb-3 pl-3 pr-3 mt-2">
                        <h4>
                            <i class="fa fa-info-circle etabib-color"></i>
                            {% trans 'أتعاب الاستشارة' %}
                        </h4>
                        <dt class="field text-left">{% trans 'الاستشارة في العيادة' %}</dt>
                        <dd>
                            <label>
                                {{contact.medecin.tarif_cslt_cabinet|default_if_none:""}}
                            </label>
                        </dd>
                        <dt class="field text-left">{% trans 'الاستشارة في المنزل' %}</dt>
                        <dd>
                            <label>
                                {{contact.medecin.tarif_cslt_domicile|default_if_none:""}}
                            </label>
                        </dd>
                        <dt class="field text-left">{% trans 'الاستشارة عن بعد' %}</dt>
                        <dd>
                            <label>
                                {{contact.medecin.tarif_consultation|default_if_none:""}}
                            </label>
                        </dd>
                    </div>
                </div>
            </div>
            <!-- end panel -->
        </div>
    </div>
</div>
{% endblock %}
{% block js %}
{% if contact.medecin %}
<!-- Uppy -->
<script src="https://releases.transloadit.com/uppy/v2.6.0/uppy.min.js"></script>
<script src="https://releases.transloadit.com/uppy/locales/v2.0.6/fr_FR.min.js"></script>
<script src="https://releases.transloadit.com/uppy/locales/v2.0.6/ar_SA.min.js"></script>
<!-- #modal-dialog -->
<div class="modal fade" id="modal-rdv">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title">{% trans 'Demande de Rendez-vous' %}</h4>
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
            </div>
            <div class="modal-body">
                {% crispy form_rdv form_rdv.helper %}
                <div class="progress rounded-corner">
                  <div class="progress-bar"></div>
                </div>
            </div>
            <div class="modal-footer">
                <a href="javascript:;" class="btn btn-white" data-dismiss="modal">{% trans 'Fermer'%}</a>
                <a href="javascript:;" id="btn_send" class="btn btn-etabib">{% trans 'Envoyer' %}</a>
            </div>
        </div>
    </div>
</div>
{% endif %}
<!-- /.modal -->
{% include "fm/modal.html" with lg=True hide_footer=True %}
<script type="text/javascript">
$(function() {
    $.fm({debug: true});

    {% if contact.medecin %}
    // Uppy is used for the UX
    // the file-upload is classic
    const uppy = new Uppy.Core({
      locale: Uppy.locales.fr_FR,
      restrictions: {
        maxNumberOfFiles: 4,
        maxFileSize : 14000000, //14Mb
        allowedFileTypes:['image/*'],
      },
    });
    uppy.use(Uppy.Dashboard, {
        target:'#div_lettres',
        inline: true,
        hideUploadButton: true,
        height: 280,
        locale: {
            strings: {
                dropPasteFiles: "%{browseFiles}", dropPasteFolders: "", dropPasteBoth: "", dropPasteBoth: "",
                browseFiles: "Cliquez Ici pour Télecharger votre Lettre d'Orientation",
                browseFolders: "",
            },
        },
    });
    var type = 1;
    $('select').on('change', function() {
      type = this.value;
    });
    $('#btn_send').on('click', function(e){
        $('.progress-bar').css('display: block !important;')
        var formdata = new FormData();
        formdata.append('type_rdv', type);
        for(let i = 0; i < uppy.getFiles().length; i++){
            console.log(uppy.getFiles()[i].data);
            formdata.append('file_' + i + '.jpg', uppy.getFiles()[i].data);
        }
        $.ajax({
            url: "{% url 'virtual-office-rdv' contact.medecin.id %}",
            data: formdata,
            type: 'POST',
            contentType: false,
            processData: false,
            xhr: function(){
                var xhr = new XMLHttpRequest();
                xhr.upload.addEventListener('progress', function(e){
                    if(e.lengthComputable){
                        var uploadPercent =  e.loaded / e.total;
                        uploadPercent =  Math.floor(uploadPercent * 100);

                        $('.progress-bar').text(uploadPercent + '%');
                        $('.progress-bar').width(uploadPercent + '%');

                        if(uploadPercent == 100){
                            $('.progress-bar').text('Completed');
                            $('#completed').text('File Uploaded');
                        }
                    }
                }, false);
                return xhr;
            },
            statusCode: {
                200: function() {
                    console.log('200');
                    $("#modal-rdv").modal('hide');
                    location.reload();
                },
                400: function() {
                    console.log("400");
                    $("#modal-rdv").modal('hide');
                },
            },
        });

    {% endif %}
    });

    const WS_CMD_DMND_REQUEST = "TELECONSULTATION_DEMAND";
    const WS_CMD_DMND_ACCEPTED = "TELECONSULTATION_DEMAND_ACCEPTED";
    const WS_CMD_DMND_CANCELED = "TELECONSULTATION_DEMAND_CANCELED";
    const WS_CMD_DMND_REJECTED = "TELECONSULTATION_DEMAND_REJECTED";
    const WS_CMD_ONLINE_DOC_COUNT =  "TELECONSULTATION_GET_ONLINE_DOCTORS_COUNT";
    var progress_is_shown = false;
    var medecin_id;

    notifSocket.addEventListener("message", function(e) {
        var data = JSON.parse(e.data);
        var command = data['command'];
        switch (command) {
            case WS_CMD_ONLINE_DOC_COUNT:
                var count = data['count'];
                $("#count").html(count);
                break;
            case WS_CMD_DMND_REJECTED:
                var code = data['code'];
                var msg="";
                if (code=="BUSY") {
                    msg = '{% trans "Désolé, le médecin est actuellement occupé." %}';
                } else if (code == "OFFLINE") {
                    msg = '{% trans "Désolé, le médecin est actuellement hors ligne." %}';
                } else if (code == "NOT_ENOUGH_MONEY") {
                    window.location.href = "{% url 'epayment-recharge' %}?u={% user_id_hash user %}&r=NOT_ENOUGH_MONEY";
                    return;
                }
                else {
                    msg = '{% trans "Désolé, le service est actuellement indisponible. réessayez après 1 minute" %}';
                }
                Lobibox.alert('warning',
                    {
                        title: ".",
                        buttons: {
                            ok: {
                                closeOnClick: true,
                                'class': 'btn btn-etabib',
                                text: "<i class='fa fa-check fa-2x'></i>"
                            }
                        },
                        msg: msg
                    }
                );
                break;
        }
    });

    $(document).on('click', '.demand-rdv',function() {
        //read data attribute from li element
        medecin_id = $(this).data("medecin-id");
        var medecin_name = $(this).data("medecin-name");
        var has_rdv = $(this).data("has-rdv") == "True" ? true : false;
        var demand_id = $(this).data("demand-id");
        var msgAdd = "{% trans 'Je confirme ma demande de rendez-vous avec Dr. ' %} " + medecin_name + "?";
        var msgCancel = "{% trans "Je confirme ma demande d'annuler le rendez-vous avec Dr. " %} " + medecin_name + "?";
        var url = has_rdv ? "{% url 'can_demande-rdv' %}" : "{% url 'add-demande-rdv' %}"
        var btn = $(this);

        //show confirmation notification
        var lobibox = Lobibox.confirm({
            title: "{% trans 'Confirmation' %}",
            iconClass: false,
            buttons: {
                yes: {
                    closeOnClick: true,
                    'class': 'btn btn-etabib',
                    text: "<i class='fa fa-calendar fa-2x'></i>"
                },
                no: {
                    closeOnClick: true,
                    'class': 'btn btn-etabib',
                    text: "<i class='fa fa-times fa-2x'></i>"
                },
            },
            closable: false,
            msg: has_rdv ? msgCancel : (msgAdd + '{% render_rdv_types %}'),
            callback: function($this, type, ev) {
                if (type === 'yes') {
                    var rdv_choice = $('#rdv_choices').val();
                    var rdv_choice_text = $( "#rdv_choices option:selected" ).text();
                    var data = {
                        'doctor_id': medecin_id,
                        'demande_id': demand_id,
                        'rdv_choice': rdv_choice,
                        'csrfmiddlewaretoken': '{{ csrf_token }}'
                    };
                    $.post( url, data)
                      .fail(function(xhr, status, error) {
                        var status = xhr.status;
                        if (status==406) {
                            Lobibox.notify(
                            'warning',{
                                title: ""
                                , msg:"{% trans "Le serveur est occupé maintenant, essayez d'envoyer une demande toutes les 30 secondes" %} "
                                , position: 'right top'
                            });
                        }
                        else if (status==402) {
                            window.location.href = "{% url 'epayment-recharge' %}?u={% user_id_hash user %}&r=NOT_ENOUGH_MONEY";
                            return;
                        }
                        else {
                             Lobibox.notify(
                            'error',{
                                title: "Server error"
                                , msg:"{% trans "Something went wrong" %} "
                                , position: 'right top',
                                icon: 'fa fa-times-circle'
                            });
                        }
                      })
                      .done(function( data, statusText, xhr ) {
                        var status = xhr.status;
                        if (!has_rdv) {
                            if (status==201) {
                                btn.data('demand-id', data.demande_id);
                                btn.data('has-rdv', 'True');
                                Lobibox.notify(
                                'success',{
                                    title: "{% trans 'Demande envoyée!' %} "
                                    , msg:"{% trans 'Vous aviez demandé un rendez-vous' %} " + rdv_choice_text + " {% trans 'avec Dr. ' %} " + medecin_name
                                    , position: 'right top',
                                    'icon': 'fa fa-check-circle'
                                });
                            }
                        }
                        else {
                            if (status==200) {
                                btn.data('demand-id', '');
                                btn.data('has-rdv', "False");
                                Lobibox.notify(
                                'success',{
                                    title: "{% trans 'Demande annulée!' %} "
                                    , msg:"{% trans 'Vous aviez annuler le rendez-vous avec Dr. ' %} " + medecin_name
                                    , position: 'right top',
                                    'icon': 'fa fa-check-circle'
                                });
                            }
                            location.reload();
                        }
                    });
                }
            }
        });
    });

    $(document).on('click', '.demand-teleconsultation', function() {
        var bool = CheckBrowserCompatibility();
        if (!bool) return;

        //read data attribute from li element
        medecin_id = $(this).data("medecin-id");
        var medecin_name = $(this).data("medecin-name");

        //Checking if socket is opened
        if (notifSocket.readyState === WebSocket.OPEN) {

            //show confirmation notification
            var lobibox = Lobibox.confirm({
                title: "{% trans 'Confirmation' %}",
                iconClass: false,
                buttons: {
                    yes: {
                        closeOnClick: true,
                        'class': 'btn btn-etabib',
                        text: "<i class='fa fa-video fa-2x'></i>"
                    },
                    no: {
                        closeOnClick: true,
                        'class': 'btn btn-etabib',
                        text: "<i class='fa fa-times fa-2x'></i>"
                    },
                },
                closable: false,
                msg: "{% trans 'Vous confirmez la consultation avec DR' %} " + medecin_name + "?",
                callback: function($this, type, ev) {
                    if (type === 'yes') {
                        //if yes: send through the Websocket the teleconsultation demand
                        var progress_notif = Lobibox.progress({
                            closeButton: false,
                            progressTpl: '<div class="progress lobibox-progress-outer" style="height:5px;">\n\
                            <div class="progress-bar progress-bar-warning progress-bar-striped lobibox-progress-element" data-role="progress-text" style="height:5px;" role="progressbar"></div>\n\
                            </div>',
                            title: "{% trans 'En attente de connexion avec DR' %} " + medecin_name,
                            progressCompleted: function(lbx) {
                                progress_is_shown = false;
                                //send request to cancel demand
                                notifSocket.send(JSON.stringify({
                                    'command': WS_CMD_DMND_CANCELED,
                                    'medecin_id': medecin_id
                                }));
                                //TODO: Message NO RESPONSE
                                lbx.hide();
                            },
                            onShow: function(lbx) {
                                progress_is_shown = true;
                                if (notifSocket.readyState === WebSocket.OPEN) {
                                    var inter;
                                    notifSocket.send(JSON.stringify({
                                        'command': WS_CMD_DMND_REQUEST,
                                        'medecin_id': medecin_id
                                    }));
                                    //add listener to check on message event
                                    notifSocket.addEventListener("message", function(e) {
                                        var data = JSON.parse(e.data);
                                        var command = data['command'];
                                        switch (command) {
                                            case WS_CMD_DMND_ACCEPTED:
                                            case WS_CMD_DMND_REJECTED:
                                                inter = clearInterval(inter);
                                                //hide progress
                                                lbx.destroy();
                                                progress_is_shown = false;
                                                break;
                                        }
                                    });
                                    var i = 0;
                                    var step = 10;
                                    inter = setInterval(function() {
                                        if (i > 100) {
                                            inter = clearInterval(inter);
                                        }
                                        i = i + 0.025;
                                        lbx.setProgress(i);
                                    }, step);
                                }
                            }
                        });
                    }
                }
            });
        }
        else {
            //socket is not opened notify the user
            //TODO:
        }
    });

    $(document).on('click', '.add-doc-team', function() {
       var medecin_id = $(this).data("medecin-id");
       var data = {
          "medecin_id": medecin_id,
          'csrfmiddlewaretoken': '{{ csrf_token }}'
       };

       var lobibox = Lobibox.confirm({
            title: "{% trans 'Confirmation' %}",
            iconClass: false,
            buttons: {
                yes: {
                    closeOnClick: true,
                    'class': 'btn btn-etabib',
                    text: "<i class='fa fa-check fa-2x'></i>"
                },
                no: {
                    closeOnClick: true,
                    'class': 'btn btn-etabib',
                    text: "<i class='fa fa-times fa-2x'></i>"
                },
            },
            closable: false,
            msg: "{% trans "Je confirm ma demande d'ajouter le médecin à mon équipe de soins." %}",
            callback: function($this, type, ev) {
                if (type === 'yes') {
                     $.post("{% url 'patient-care-team-add' %}", data)
                          .fail(function(xhr, status, error) {
                            var status = xhr.status;
                          })
                          .done(function( data, statusText, xhr ) {
                            var status = xhr.status;
                            if (status==200) {
                                Lobibox.notify(
                                'success',{
                                    title: "{% trans 'Demande envoyé!' %} "
                                    , msg:""
                                    , position: 'right top',
                                    'icon': 'fa fa-check-circle'
                                });
                            }
                     });
                }
            }
        });
    });

    //detect browser close event
    $(window).on("beforeunload", function() {
        if (progress_is_shown == true) {
            //send request to cancel demand
            notifSocket.send(JSON.stringify({
                'command': WS_CMD_DMND_CANCELED,
                'medecin_id': medecin_id
            }));
            //close socket
            notifSocket.close();
        }
    });
});
</script>
{% endblock %}
